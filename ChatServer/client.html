<!DOCTYPE html>
<html>

<head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript">
        var socketio = io.connect();
        socketio.on("message_to_client", function (data) {
            //Append an HR thematic break and the escaped HTML of the new message
            document.getElementById("chatlog").appendChild(document.createElement("hr"));
            document.getElementById("chatlog").appendChild(document.createTextNode(data['message']));
            let sentBy = "sent by " + data.username;
            $("<br>").appendTo("#chatlog");
            $("#chatlog").append(document.createTextNode(sentBy));


        });

        function sendMessage() {
            let msg = document.getElementById("message_input").value;
            $("#message_input").empty();
            socketio.emit("message_to_server", {
                message: msg
            });
        }

        function addRoom() {
            //get room name from form
            let newRoomName = document.getElementById("new_room_name").value;

            //add room name to list
            /*document.getElementById("roomList").appendChild(document.createElement("hr"));
            document.getElementById("roomList").appendChild(document.createTextNode(newRoomName));*/

            //emit that new room was added
            socketio.emit("addRoom", {
                roomName: newRoomName,
            });

            socketio.emit("getRooms");

        }

        //set username variable of socket to username set by user
        //emit usernameSet
        function setUserName() {
            let userNameInput = document.getElementById("username_input").value;

            console.log(userNameInput);
            socketio.emit("userNameSet", {
                username: userNameInput
            });
            $('#username_input').val("");

            socketio.emit("getRooms");
        }

        //helper function to debug
        function printArray2(array2) {
            for (index in array2) {
                console.log(array2[index]);
            }
        }
        //show the roomsList div
        //ask server for list of rooms ("getRooms")
        function showRoomsList(rooms) {
            $("#roomList").empty();
            console.log("begin allowed rooms");
            printArray2(rooms);
            console.log("end allowed rooms");
            for (index in rooms) {
                console.log("id: " + rooms[index].roomName);
                $("#roomList").append(document.createElement("hr"));
                $("#roomList").append(document.createTextNode(rooms[index].roomName));
                $("<button>", {
                    id: rooms[index].roomName
                }).appendTo("#roomList");
                $("#" + rooms[index].roomName).append(document.createTextNode("Join room"));
                console.log("id of click " + rooms[index].roomName);
                $("#" + rooms[index].roomName).click((e) => {
                    //console.log(rooms[index]);
                    console.log("user joining room with name " + e.target.id);
                    //console.log("user joining room " + socketio.username)
                    socketio.emit("joinRoom", {
                        username: socketio.username,
                        roomName: e.target.id
                    })
                })
            }
        }

        socketio.on("roomJoined", (data) => {
            $(".rooms").hide();
            $(".sign_in").hide();
            $(".message").show();
            console.log("joined user is " + data.username);
            //console.log("joined user from socket " + socketio.username);
            //alert(socketio.username + " has joined the room");
        })

        //socket listener for rooms list ("currentRooms")
        socketio.on("currentRooms", function (data) {
            showRoomsList(data.rooms)
        });

        //leave a room
        function leaveRoom() {
            socketio.emit("leaveRoom");
            $(".message").hide();
            $(".rooms").show();
        }

        socketio.on('roomLeft', (data) => {
            console.log(data.username + " has left the room");
        })
    </script>
</head>

<body>
    <!--Set username-->
    <!--form to set user name-->

    <input type="text" id="username_input" class="sign_in">
    <button onclick="setUserName()" class="sign_in">Set User Name</button> <br>


    <!--Chat Log and send chat and leave chat-->
    <input type="text" id="message_input" class="message" />
    <button onclick="sendMessage()" class="message">Send</button>
    <button onclick="leaveRoom()" class="message">Leave</button>
    <div id="chatlog" class="message"></div>

    <!--Rooms List and add room-->
    <input type="text" id="new_room_name" class="rooms" />
    <!-- make a div to hold all rooms -->


    <button onclick="addRoom()" class="rooms">Add New Room</button>
    <div id="roomList" class="rooms">

    </div>



    <!--Kick and ban forms-->






</body>

</html>